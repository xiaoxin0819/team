<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>ç»„é˜ŸåŠ©æ‰‹</title>
    <style>
        :root { --p: #07c160; --bg: #f8f9fa; --card: #ffffff; --text: #444; --blue: #007aff; --red: #ee0a24; --gold: #FFD700; --orange: #ff9500; }
        body { font-family: "Heiti SC", "STHeiti", "SimHei", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); font-weight: 300; }
        
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h3 { margin: 0 0 15px 0; font-size: 15px; font-weight: 400; color: #1a1a1a; display: flex; align-items: center; }
        h3::before { content: ""; width: 3px; height: 14px; background: var(--p); border-radius: 2px; margin-right: 8px; }
        
        textarea, input, select { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; outline: none; box-sizing: border-box; font-size: 13px; font-weight: 300; margin-bottom: 10px; }

        .btn { width: 100%; border: none; border-radius: 8px; padding: 12px; font-size: 15px; font-weight: 300; cursor: pointer; color: #fff; margin-bottom: 10px; display: block; text-align: center; }
        .btn-green { background: var(--p); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-orange { background: var(--orange); }
        .btn-group { display: flex; gap: 10px; }
        .btn-half { flex: 1; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 85%; padding: 20px; border-radius: 12px; text-align: center; max-height: 80vh; overflow-y: auto; }
        
        .c-name { font-weight: bold; color: #000; font-size: 15px; }
        .c-power { color: var(--red); font-weight: 400; }
        .c-job { color: var(--gold); font-weight: bold; font-size: 11px; }

        .member-card { border-bottom: 1px solid #f2f2f2; padding: 15px 0; position: relative; }
        .m-header { margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; padding-right: 45px; }
        .btn-del { position: absolute; right: 0; top: 12px; color: var(--red); font-size: 12px; border: 1px solid var(--red); padding: 2px 6px; border-radius: 4px; cursor: pointer; }
        
        .tag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tag { padding: 10px 8px; background: #fff; border: 1px solid #eee; border-radius: 6px; text-align: center; cursor: pointer; }
        .tag .t-n { display: block; font-weight: bold; color: #000; font-size: 14px; margin-bottom: 2px; }
        .tag.active { background: #f0f9f4; border-color: var(--p); }
        .tag.active .t-n { color: var(--p); }

        .res-item { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; line-height: 1.6; text-align: left; }
        .type-fixed { background: #f0f6ff; border-left: 3px solid var(--blue); }
        .type-match { background: #f4faf6; border-left: 3px solid var(--p); }
    </style>
</head>
<body>

<div id="parseModal" class="modal">
    <div class="modal-content">
        <h3 style="justify-content:center">è§£ææˆåŠŸ</h3>
        <div id="parseSummary" style="font-size:14px; line-height:1.8; margin-bottom:15px; text-align:left;"></div>
        <button class="btn btn-green" onclick="document.getElementById('parseModal').style.display='none'">ç¡®è®¤</button>
    </div>
</div>

<div class="card">
    <h3>1. å½•å…¥æ•°æ®</h3>
    <textarea id="importBox" placeholder="ç²˜è´´æ¥é¾™æ–‡æœ¬..."></textarea>
    <button class="btn btn-green" onclick="smartImport()">æ™ºèƒ½è§£ææ¥é¾™</button>
    
    <div class="manual-box" style="background:#fdfdfd; border:1px dashed #ddd; padding:12px; border-radius:10px;">
        <input type="text" id="m_name" placeholder="æ˜µç§°">
        <select id="m_job">
            <option value="æœ¯å£«">æœ¯å£«</option><option value="è´¤è€…">è´¤è€…</option><option value="éª‘å£«">éª‘å£«</option><option value="æ–—å£«">æ–—å£«</option>
        </select>
        <input type="number" id="m_power" placeholder="æˆ˜åŠ›æ•°å€¼">
        <button class="btn btn-orange" style="padding:8px" onclick="addManual()">ç¡®è®¤åŠ å…¥åå•</button>
    </div>

    <div class="btn-group" style="margin-top:15px;">
        <button class="btn btn-blue btn-half" onclick="openShare()">åˆ†äº«é¡µé¢</button>
        <button class="btn btn-red btn-half" onclick="clearAll()">é‡ç½®æ¸…ç©º</button>
    </div>
</div>

<div class="card">
    <h3>2. å¾…åŒ¹é…äººå‘˜</h3>
    <div id="list" style="color:#bbb; text-align:center; padding:15px 0;">ç­‰å¾…å½•å…¥æ•°æ®...</div>
</div>

<button class="btn btn-blue" style="font-size: 16px; padding: 18px; border-radius:12px;" onclick="match()">ç”Ÿæˆæ–¹æ¡ˆ </button>
<div id="res"></div>

<script>
    let ms = [], fixedTs = [], unit = "ä¸‡";
    const JOBS = ["æœ¯å£«", "éª‘å£«", "æ–—å£«", "è´¤è€…"];
    const STATUS = ["æœªç»„é˜Ÿ", "å°šæœª", "å¾…ç»„", "ç¼º", "å·®", "è¡¥"];

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const d = urlParams.get('d');
        if(d) {
            try {
                const json = JSON.parse(decodeURIComponent(atob(d)));
                ms = json.ms; fixedTs = json.fs; unit = json.u; render(); return;
            } catch(e) {}
        }
        ms = JSON.parse(localStorage.getItem('tm_ms') || '[]');
        fixedTs = JSON.parse(localStorage.getItem('tm_fs') || '[]');
        unit = localStorage.getItem('tm_u') || 'ä¸‡';
        render();
    }

    function smartImport() {
        const text = document.getElementById('importBox').value;
        if(!text.trim()) return;
        unit = text.includes("äº¿") ? "äº¿" : "ä¸‡";
        const lines = text.split('\n');
        let tM = [], tF = [], allF = new Set();
        lines.forEach(l => {
            const row = l.trim();
            if(!/^\d+\./.test(row)) return;
            const blocks = row.replace(/^\d+\.\s*/, '').split(/\s+/).filter(b => b.length > 0);
            if (!STATUS.some(s => row.includes(s)) && blocks.length >= 4) {
                const names = blocks.slice(0, 4);
                tF.push(names.join(' ã€ '));
                names.forEach(n => allF.add(n));
            } else if (blocks.length > 0) {
                const name = blocks[0];
                if(!allF.has(name)) {
                    let job = "æœªçŸ¥";
                    JOBS.forEach(j => { if(row.includes(j)) job = j; });
                    const pMatch = row.match(/(\d+\.?\d*)/g);
                    const pVal = pMatch ? parseFloat(pMatch[pMatch.length - 1]) : 0;
                    if(!tM.some(m => m.n === name)) tM.push({n: name, j: job, p: pVal, pre: []});
                }
            }
        });
        ms = tM.filter(m => !allF.has(m.n)); fixedTs = tF;
        save(); render();
        document.getElementById('parseSummary').innerHTML = `âœ… è§£ææˆåŠŸï¼<br>â”â”â”â”â”â”â”â”â”â”â”â”<br>ğŸ”¹ å·²æˆç»„ï¼š${fixedTs.length}<br>ğŸ”¹ å¾…åŒ¹é…ï¼š${ms.length}<br>ğŸ”¹ å•ä½ï¼š${unit}`;
        document.getElementById('parseModal').style.display = 'flex';
        document.getElementById('importBox').value = "";
    }

    function addManual() {
        const name = document.getElementById('m_name').value.trim();
        const job = document.getElementById('m_job').value;
        const power = parseFloat(document.getElementById('m_power').value);
        if(!name || isNaN(power)) return alert("è¯·å¡«å†™æ˜µç§°å’Œæˆ˜åŠ›");
        ms.push({ n: name, j: job, p: power, pre: [] });
        save(); render();
        document.getElementById('m_name').value = ""; document.getElementById('m_power').value = "";
    }

    function removeOne(idx) {
        if(confirm(`ç¡®å®šç§»é™¤ ${ms[idx].n}ï¼Ÿ`)) { ms.splice(idx, 1); save(); render(); }
    }

    function render() {
        const box = document.getElementById('list');
        if(!ms.length) { box.innerHTML = 'æš‚æ— æ•°æ®'; return; }
        box.innerHTML = ms.map((m, i) => `
            <div class="member-card">
                <div class="m-header">
                    <span class="c-name">${m.n}</span>
                    <span style="font-size:11px"><span class="c-job">${m.j}</span> | <span class="c-power">${m.p}${unit}</span></span>
                </div>
                <div class="btn-del" onclick="removeOne(${i})">ç§»é™¤</div>
                <div class="tag-grid">
                    ${ms.map((t, k) => i===k ? '' : `
                        <div class="tag ${m.pre.includes(t.n)?'active':''}" onclick="sel(${i},'${t.n}')">
                            <span class="t-n">${t.n}</span>
                            <span style="font-size:10px"><span class="c-power">${t.p}${unit}</span> <span class="c-job">${t.j}</span></span>
                        </div>`).join('')}
                </div>
            </div>`).join('');
    }

    function sel(idx, name) {
        const m = ms[idx], p = m.pre.indexOf(name);
        if(p > -1) m.pre.splice(p, 1);
        else { if(m.pre.length >= 3) return alert("é™é€‰3äºº"); m.pre.push(name); }
        save(); render();
    }

    function save() { 
        localStorage.setItem('tm_ms', JSON.stringify(ms)); 
        localStorage.setItem('tm_fs', JSON.stringify(fixedTs)); 
        localStorage.setItem('tm_u', unit);
    }

    function openShare() {
        const data = btoa(encodeURIComponent(JSON.stringify({ms, fs:fixedTs, u:unit})));
        const url = window.location.origin + window.location.pathname + "?d=" + data;
        window.prompt("è¯·å¤åˆ¶ä¸‹æ–¹é“¾æ¥åˆ†äº«ï¼š", url);
    }

    function clearAll() { if(confirm("å…¨éƒ¨é‡ç½®ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    // --- å·…å³°ç®—æ³•ï¼šå¼ºå¼ºè”æ‰‹æ ¸å¿ƒé€»è¾‘ ---
    function match() {
        let used = new Set(), results = [];
        // æŒ‰ç…§æˆ˜åŠ›ä»é«˜åˆ°ä½æ’åºå…¨å±€æ± 
        let pool = [...ms].sort((a,b) => b.p - a.p);

        // 1. å¤„ç†æ‰‹åŠ¨æ„å‘ (ç»å¯¹ä¼˜å…ˆçº§)
        pool.forEach(m => {
            if (used.has(m.n)) return;
            if (m.pre.length > 0) {
                let team = [m]; used.add(m.n);
                m.pre.forEach(favName => {
                    if (team.length < 4 && !used.has(favName)) {
                        let favMember = pool.find(p => p.n === favName);
                        if (favMember) { team.push(favMember); used.add(favName); }
                    }
                });
                if (team.length > 0) results.push(team);
            }
        });

        // 2. å¼ºå¼ºè”æ‰‹ï¼šä¸ºæ²¡æœ‰æ„å‘çš„é«˜æˆ˜æœ¯å£«åŒ¹é…é«˜æˆ˜é˜Ÿå‹
        while (true) {
            let left = pool.filter(p => !used.has(p.n));
            if (left.length === 0) break;

            // å¯»æ‰¾å‰©ä½™ä¸­æœ€é«˜çš„æœ¯å£«
            let topSS = left.find(p => p.j === "æœ¯å£«");
            
            if (topSS) {
                // å¦‚æœæœ‰æœ¯å£«ï¼Œæ‰¾æœ€é«˜æˆ˜åŠ›æœ¯å£«å¼€ç»„
                let team = [topSS]; used.add(topSS.n);
                // å¯»æ‰¾å‰©ä½™ä¸­æœ€å¼ºçš„å‰3ä¸ªé˜Ÿå‹ (ä¸åˆ†èŒä¸šï¼Œåªçœ‹æˆ˜åŠ›é«˜ä½)
                let topPartners = pool.filter(p => !used.has(p.n)).slice(0, 4 - team.length);
                topPartners.forEach(p => { team.push(p); used.add(p.n); });
                results.push(team);
            } else {
                // å¦‚æœæ²¡æœ¯å£«äº†ï¼Œç›´æ¥å–å‰©ä¸‹æœ€é«˜æˆ˜åŠ›çš„4äººæˆç»„
                let team = [];
                let topLeft = pool.filter(p => !used.has(p.n)).slice(0, 4);
                if (topLeft.length === 0) break;
                topLeft.forEach(p => { team.push(p); used.add(p.n); });
                results.push(team);
            }
        }

        // æ¸²æŸ“ç»“æœ
        let h = `<h3>åŒ¹é…æ–¹æ¡ˆç»“æœ</h3>`;
        fixedTs.forEach((t, i) => h += `<div class="res-item type-fixed"><b>å·²æˆç»„ ${i+1}</b><br>${t}</div>`);
        results.forEach((t, i) => {
            const hasSS = t.some(m => m.j==="æœ¯å£«") ? " (å«æœ¯å£«)" : " (ç¼ºæœ¯å£«)";
            const isIntent = t.some(m => m.pre.length > 0) ? "æ„å‘ç»„" : "å¼ºå¼ºç»„";
            h += `<div class="res-item type-match"><b>${isIntent} ${i+1}${hasSS}</b><br>${t.map(m => `<span style="font-weight:bold;color:#000;">${m.n}</span>(<span style="color:var(--red)">${m.p}${unit}</span> <span style="color:var(--gold);font-weight:bold;">${m.j}</span>)`).join(' ã€ ')}</div>`;
        });
        document.getElementById('res').innerHTML = h;
        document.getElementById('res').scrollIntoView();
    }
</script>
</body>
</html>
