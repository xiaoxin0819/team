<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>组队助手-回归版</title>
    <style>
        :root { --p: #07c160; --bg: #f2f2f7; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; font-size: 16px; color: #333; border-left: 4px solid var(--p); padding-left: 10px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: #fff; margin-bottom: 10px; cursor: pointer; font-size: 16px; }
        .member { background: #fafafa; border: 1px solid #eee; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .tag { display: inline-block; padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin: 4px; font-size: 14px; }
        .tag.active { background: var(--p); color: #fff; border-color: var(--p); }
        
        /* 核心修复：链接显示区 */
        #shareBox { display: none; background: #fffbe6; border: 2px dashed #ff9500; padding: 12px; border-radius: 10px; margin-top: 10px; }
        #linkDisplay { width: 100%; word-break: break-all; font-size: 12px; color: #333; margin-bottom: 10px; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd; user-select: all; -webkit-user-select: all; }
    </style>
</head>
<body>

<div class="card">
    <h3>1. 成员录入</h3>
    <input id="un" placeholder="昵称 (必填)">
    <input id="uj" placeholder="职业 (必填)">
    <input id="up" placeholder="战力 (必填)">
    <button class="btn" style="background:var(--p)" onclick="addOne()">确定录入</button>
    <button class="btn" style="background:#fa9d3b" onclick="makeUrl()">生成并显示分享链接</button>
    
    <div id="shareBox">
        <p style="margin:0 0 8px; font-size:14px; color:#856404; font-weight:bold;">⚠️ 自动复制可能被拦截，请长按下方文字【全选复制】：</p>
        <div id="linkDisplay"></div>
        <p style="margin:5px 0 0; font-size:12px; color:#999;">复制后发给群友，接龙录入或勾选。</p>
    </div>
</div>

<div class="card">
    <h3>2. 互选名单 (限选3人)</h3>
    <div id="list">还没有成员，请先录入...</div>
</div>

<button class="btn" style="background:#10aeff" onclick="doMatch()">点击生成匹配结果</button>
<div id="res"></div>

<script>
    var dataList = [];

    // 页面加载时读取链接里的数据
    window.onload = function() {
        var params = new URLSearchParams(window.location.search);
        var encodedData = params.get('d');
        if (encodedData) {
            try {
                dataList = JSON.parse(decodeURIComponent(encodedData));
                renderList();
            } catch(e) { console.error("解析数据失败"); }
        }
    }

    // 录入
    function addOne() {
        var n = document.getElementById('un').value.trim();
        var j = document.getElementById('uj').value.trim();
        var p = document.getElementById('up').value.trim();
        if(!n || !j || !p) return alert("请把信息填全");
        dataList.push({n:n, j:j, p:p, pre:[]});
        document.getElementById('un').value = '';
        renderList();
    }

    // 渲染
    function renderList() {
        var html = '';
        for(var i=0; i<dataList.length; i++){
            var m = dataList[i];
            html += '<div class="member"><b>'+m.n+'</b> <small>('+m.j+'|'+m.p+')</small><br>';
            html += '<small style="color:#666">已选: '+m.pre.length+'/3</small><br>';
            for(var k=0; k<dataList.length; k++){
                if(dataList[k].n != m.n){
                    var isSel = m.pre.indexOf(dataList[k].n) > -1;
                    html += '<span class="tag '+(isSel?'active':'')+'" onclick="toggleSel('+i+',\''+dataList[k].n+'\')">'+dataList[k].n+'</span>';
                }
            }
            html += '</div>';
        }
        document.getElementById('list').innerHTML = html || '还没有成员，请先录入...';
    }

    // 勾选
    function toggleSel(idx, targetName) {
        var me = dataList[idx];
        var found = me.pre.indexOf(targetName);
        if(found > -1) {
            me.pre.splice(found, 1);
        } else {
            if(me.pre.length >= 3) return alert("每人最多选3个");
            me.pre.push(targetName);
        }
        renderList();
    }

    // 核心修复：生成链接并直接在网页上展示
    function makeUrl() {
        if(dataList.length == 0) return alert("名单里还没人");
        var jsonStr = JSON.stringify(dataList);
        var finalUrl = window.location.origin + window.location.pathname + '?d=' + encodeURIComponent(jsonStr);
        
        // 尝试自动复制（微信可能拦截）
        var tempInput = document.createElement("textarea");
        tempInput.value = finalUrl;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);

        // 强制在页面显示链接，解决你截图中的问题
        document.getElementById('linkDisplay').innerText = finalUrl;
        document.getElementById('shareBox').style.display = 'block';
        document.getElementById('shareBox').scrollIntoView();
    }

    // 组队逻辑
    function doMatch() {
        if(dataList.length == 0) return;
        var used = {}, results = [], pool = JSON.parse(JSON.stringify(dataList));
        while(pool.length > 0) {
            var c = pool.shift(); if(used[c.n]) continue;
            var team = [c.n + '('+c.j+')']; used[c.n] = true;
            for(var i=0; i<c.pre.length; i++){
                if(!used[c.pre[i]] && team.length < 4){ team.push(c.pre[i]); used[c.pre[i]] = true; }
            }
            for(var i=0; i<dataList.length; i++){
                if(!used[dataList[i].n] && team.length < 4){ team.push(dataList[i].n); used[dataList[i].n] = true; }
            }
            results.push(team);
        }
        var resHtml = '';
        for(var i=0; i<results.length; i++){
            resHtml += '<div style="background:#e8f5e9;padding:12px;margin-top:10px;border-radius:8px;border-left:5px solid #07c160;"><b>第'+(i+1)+'组:</b> '+results[i].join(' 、 ')+'</div>';
        }
        document.getElementById('res').innerHTML = resHtml;
    }
</script>
</body>
</html>
