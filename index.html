<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>ç»„é˜ŸåŠ©æ‰‹</title>
    <style>
        :root { --p: #07c160; --bg: #f6f7f9; --sub: #888; --red: #ff4d4f; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; }
        .card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h3 { margin: 0 0 15px 0; font-size: 17px; display: flex; align-items: center; }
        h3::before { content: ""; width: 4px; height: 16px; background: var(--p); border-radius: 2px; margin-right: 8px; }
        
        input, select, textarea { width: 100%; padding: 12px 15px; margin-bottom: 12px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 14px; background: #fafafa; outline: none; }
        textarea { height: 100px; resize: none; border-color: #ddd; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 600; color: #fff; margin-bottom: 10px; cursor: pointer; font-size: 16px; }
        .btn:active { opacity: 0.8; }
        .btn-green { background: var(--p); }
        .btn-orange { background: #ff9500; }
        .btn-blue { background: #007aff; }
        .btn-ghost { background: #f0f2f5; color: #666; font-size: 14px; margin-top: 5px; }

        .member-item { border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        .m-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .m-info { font-weight: bold; font-size: 16px; color: #000; }
        .m-attr { font-weight: normal; font-size: 13px; color: #666; margin-left: 4px; }
        .del-btn { color: var(--red); font-size: 12px; border: 1px solid var(--red); border-radius: 6px; padding: 4px 8px; }
        
        .tag { display: inline-block; padding: 8px 10px; background: #f0f2f5; border-radius: 8px; margin: 4px 6px 4px 0; font-size: 12px; color: #555; text-align: center; min-width: 70px; }
        .tag.active { background: #e7f7ed; color: var(--p); border-color: var(--p); font-weight: bold; }
        
        #saveTip { font-size: 12px; color: var(--p); text-align: center; margin: 10px 0; display: none; }
        .res-item { background: #f0f9eb; padding: 12px; border-radius: 10px; margin-top: 10px; border-left: 4px solid var(--p); font-size: 14px; line-height: 1.8; }
    </style>
</head>
<body>

<div class="card">
    <h3>1. æ™ºèƒ½å¯¼å…¥æ¥é¾™</h3>
    <textarea id="importBox" placeholder="ç›´æ¥ç²˜è´´å¾®ä¿¡æ¥é¾™å…¨æ–‡...&#10;ä¾‹ï¼š3. å¹æ¯ä¹‹å¢™ éª‘å£« å°šæœªç»„é˜Ÿ 240ä¸‡æˆ˜åŠ›"></textarea>
    <button class="btn btn-green" onclick="smartImport()">ä¸€é”®è§£æå¹¶å¯¼å…¥</button>
    <div style="font-size:12px; color:#999; text-align:center;">*ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ˜µç§°ã€èŒä¸šå’Œæˆ˜åŠ›</div>
</div>

<div class="card">
    <h3>2. æ‰‹åŠ¨è¡¥å……/ç”Ÿæˆé“¾æ¥</h3>
    <input id="un" placeholder="æ˜µç§°">
    <select id="uj">
        <option value="" disabled selected>é€‰æ‹©èŒä¸š</option>
        <option value="æœ¯å£«">æœ¯å£«</option><option value="éª‘å£«">éª‘å£«</option>
        <option value="æ–—å£«">æ–—å£«</option><option value="è´¤è€…">è´¤è€…</option>
    </select>
    <input id="up" placeholder="æˆ˜åŠ› (å¦‚: 300ä¸‡)">
    <button class="btn btn-orange" onclick="addM()">ç¡®å®šå½•å…¥</button>
    <button class="btn btn-blue" onclick="make()">å¤åˆ¶åˆ†äº«é“¾æ¥ç»™ç¾¤å‹</button>
</div>

<div id="saveTip">âœ“ æ•°æ®å·²è‡ªåŠ¨ä¿å­˜</div>

<div class="card">
    <h3>3. å‹¾é€‰æ„å‘å¹¶è®¡ç®—</h3>
    <div id="list" style="color:#999; text-align:center; padding:10px 0;">ç­‰å¾…æ•°æ®å¯¼å…¥...</div>
    <button class="btn btn-green" style="margin-top:20px;" onclick="match()">ç”ŸæˆåŒ¹é…ç»“æœ</button>
    <button class="btn btn-ghost" onclick="clearAll()">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
</div>

<div id="res"></div>

<script>
    var ms = [];

    window.onload = function() {
        var d = new URLSearchParams(window.location.search).get('d');
        if(d) {
            try { ms = JSON.parse(decodeURIComponent(d)); render(); saveToLocal(); return; } catch(e) {}
        }
        var localData = localStorage.getItem('team_data');
        if(localData) { ms = JSON.parse(localData); render(); }
    }

    // ğŸš€ æ ¸å¿ƒåŠŸèƒ½ï¼šæ™ºèƒ½è§£æå¾®ä¿¡æ¥é¾™
    function smartImport() {
        var text = document.getElementById('importBox').value;
        if(!text.trim()) return alert("è¯·å…ˆç²˜è´´å†…å®¹");
        
        var lines = text.split('\n');
        var count = 0;
        var jobs = ["æœ¯å£«", "éª‘å£«", "æ–—å£«", "è´¤è€…"];

        lines.forEach(line => {
            // æ­£åˆ™é€»è¾‘ï¼šåŒ¹é…æ•°å­—å¼€å¤´ï¼Œæå–æ˜µç§°ï¼Œè¯†åˆ«èŒä¸šï¼Œæå–æˆ˜åŠ›æ•°å­—
            var row = line.trim();
            if(!row || !/^\d+\./.test(row)) return; // å¿…é¡»æ˜¯æ•°å­—å¼€å¤´å¦‚ "1."

            var cleanRow = row.replace(/^\d+\.\s*/, ''); // å»æ‰ç¼–å·
            var parts = cleanRow.split(/\s+/);
            
            if(parts.length >= 2) {
                var name = parts[0];
                var job = "æœªçŸ¥";
                var power = "æœªçŸ¥";

                // åœ¨æ•´è¡Œé‡ŒæœèŒä¸š
                jobs.forEach(j => { if(row.indexOf(j) > -1) job = j; });
                
                // æœæˆ˜åŠ›ï¼ˆåŒ¹é…æ•°å­—+ä¸‡ï¼‰
                var pMatch = row.match(/\d+(ä¸‡)?/g);
                if(pMatch) power = pMatch[pMatch.length-1];

                // æ£€æŸ¥æ˜¯å¦é‡å¤
                if(!ms.some(m => m.n === name)) {
                    ms.push({n: name, j: job, p: power, pre: []});
                    count++;
                }
            }
        });

        if(count > 0) {
            alert("æˆåŠŸè¯†åˆ«å¹¶å¯¼å…¥ " + count + " ä½æˆå‘˜ï¼");
            document.getElementById('importBox').value = "";
            render();
            saveToLocal();
        } else {
            alert("æœªè¯†åˆ«åˆ°æœ‰æ•ˆæˆå‘˜ï¼Œè¯·ç¡®ä¿æ ¼å¼ç±»ä¼¼ï¼š\n1. åå­— èŒä¸š æˆ˜åŠ›");
        }
    }

    function saveToLocal() {
        localStorage.setItem('team_data', JSON.stringify(ms));
        var tip = document.getElementById('saveTip');
        tip.style.display = 'block';
        setTimeout(()=> tip.style.display='none', 2000);
    }

    function clearAll() {
        if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) { ms=[]; localStorage.removeItem('team_data'); render(); }
    }

    function addM() {
        var n=document.getElementById('un').value.trim(), j=document.getElementById('uj').value, p=document.getElementById('up').value.trim();
        if(!n || !j || !p) return alert("è¯·å¡«å…¨");
        ms.push({n:n, j:j, p:p, pre:[]});
        document.getElementById('un').value=""; document.getElementById('uj').selectedIndex=0; document.getElementById('up').value="";
        render(); saveToLocal();
    }

    function delM(idx) {
        var name = ms[idx].n;
        ms.splice(idx, 1);
        ms.forEach(m => { var p=m.pre.indexOf(name); if(p>-1) m.pre.splice(p,1); });
        render(); saveToLocal();
    }

    function render() {
        var box = document.getElementById('list');
        if(ms.length == 0) { box.innerHTML = 'ç­‰å¾…æ•°æ®å¯¼å…¥...'; return; }
        var h = "";
        ms.forEach((m, i) => {
            h += `<div class="member-item">
                <div class="m-header">
                    <div class="m-info">${m.n}<span class="m-attr">(${m.j} | ${m.p})</span></div>
                    <div class="del-btn" onclick="delM(${i})">åˆ é™¤</div>
                </div>
                <div>`;
            ms.forEach((t, k) => {
                if(i!=k) {
                    var act = m.pre.indexOf(t.n) > -1;
                    h += `<span class="tag ${act?'active':''}" onclick="sel(${i},'${t.n}')">${t.n}<br><small>${t.j}</small></span>`;
                }
            });
            h += `</div></div>`;
        });
        box.innerHTML = h;
    }

    function sel(idx, name) {
        var m = ms[idx], p = m.pre.indexOf(name);
        if(p>-1) m.pre.splice(p,1); else {
            if(m.pre.length>=3) return alert("é™é€‰3äºº");
            m.pre.push(name);
        }
        render(); saveToLocal();
    }

    function make() {
        var url = window.location.origin + window.location.pathname + "?d=" + encodeURIComponent(JSON.stringify(ms));
        prompt("è¯·å¤åˆ¶ä¸‹æ–¹é“¾æ¥å‘é€ç»™ç¾¤å‹è¿›è¡Œå‹¾é€‰ï¼š", url);
    }

    function match() {
        var used = {}, ts = [], pool = JSON.parse(JSON.stringify(ms));
        var dict = {}; ms.forEach(m => dict[m.n] = m);
        var f = (n) => { var i=dict[n]; return i ? `${n}(${i.j},${i.p})` : n; };
        while(pool.length > 0) {
            var c = pool.shift(); if(used[c.n]) continue;
            var team = [f(c.n)]; used[c.n] = true;
            c.pre.forEach(t => { if(!used[t] && team.length<4){ team.push(f(t)); used[t]=true; } });
            ms.forEach(m => { if(!used[m.n] && team.length<4){ team.push(f(m.n)); used[m.n]=true; } });
            ts.push(team);
        }
        var h = "";
        ts.forEach((t, i) => h += `<div class="res-item"><b>ç¬¬ ${i+1} ç»„ï¼š</b><br>${t.join(' ã€ ')}</div>`);
        document.getElementById('res').innerHTML = `<div class="card"><h3>åŒ¹é…æ–¹æ¡ˆ</h3>${h}</div>`;
        document.getElementById('res').scrollIntoView();
    }
</script>
</body>
</html>
