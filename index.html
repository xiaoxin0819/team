<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>组队助手-正式版</title>
    <style>
        :root { --p: #07c160; --bg: #f2f2f7; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: #fff; margin-bottom: 10px; cursor: pointer; font-size: 16px; }
        .member { background: #fafafa; border: 1px solid #eee; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .tag { display: inline-block; padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin: 4px; font-size: 14px; }
        .tag.active { background: var(--p); color: #fff; border-color: var(--p); }
        /* 链接显示区样式 */
        #shareZone { display: none; background: #fffbe6; border: 1px solid #ffe58f; padding: 10px; border-radius: 8px; margin-top: 10px; }
        #linkText { width: 100%; word-break: break-all; font-size: 12px; color: #333; margin-bottom: 10px; user-select: all; -webkit-user-select: all; }
    </style>
</head>
<body>

<div class="card">
    <h3 style="margin-top:0">1. 成员录入</h3>
    <input id="un" placeholder="昵称">
    <input id="uj" placeholder="职业">
    <input id="up" placeholder="战力">
    <button class="btn" style="background:var(--p)" onclick="addM()">确定录入</button>
    <button class="btn" style="background:#fa9d3b" onclick="makeLink()">生成并显示分享链接</button>
    
    <div id="shareZone">
        <p style="margin:0 0 5px; font-size:13px; color:#856404; font-weight:bold;">请长按下方文字【全选复制】：</p>
        <div id="linkText"></div>
        <p style="margin:5px 0 0; font-size:11px; color:#999;">复制后发给群友，他们点开就能看到名单</p>
    </div>
</div>

<div class="card">
    <h3 style="margin-top:0">2. 勾选意向队友 (限选3人)</h3>
    <div id="list">暂无成员，请录入</div>
</div>

<button class="btn" style="background:#10aeff" onclick="match()">点击生成匹配结果</button>
<div id="res"></div>

<script>
    var ms = [];
    window.onload = function() {
        var p = new URLSearchParams(window.location.search);
        var d = p.get('d');
        if (d) {
            try { ms = JSON.parse(decodeURIComponent(d)); render(); } catch(e) {}
        }
    }

    function addM() {
        var n = document.getElementById('un').value.trim();
        var j = document.getElementById('uj').value.trim();
        var p = document.getElementById('up').value.trim();
        if(!n || !j || !p) return alert("填全信息");
        ms.push({n:n, j:j, p:p, pre:[]});
        document.getElementById('un').value = '';
        render();
    }

    function render() {
        var h = '';
        for(var i=0; i<ms.length; i++){
            h += '<div class="member"><b>'+ms[i].n+'</b> ('+ms[i].j+'|'+ms[i].p+')<br>';
            h += '<small>已选意向: '+ms[i].pre.length+'/3</small><br>';
            for(var k=0; k<ms.length; k++){
                if(ms[k].n != ms[i].n){
                    var act = ms[i].pre.indexOf(ms[k].n) > -1;
                    h += '<span class="tag '+(act?'active':'')+'" onclick="sel('+i+',\''+ms[k].n+'\')">'+ms[k].n+'</span>';
                }
            }
            h += '</div>';
        }
        document.getElementById('list').innerHTML = h || '暂无成员';
    }

    function sel(idx, name) {
        var m = ms[idx];
        var pos = m.pre.indexOf(name);
        if(pos > -1) { m.pre.splice(pos, 1); }
        else {
            if(m.pre.length >= 3) return alert("每人限选3人");
            m.pre.push(name);
        }
        render();
    }

    function makeLink() {
        if(ms.length == 0) return alert("名单没人");
        var d = encodeURIComponent(JSON.stringify(ms));
        var url = window.location.origin + window.location.pathname + '?d=' + d;
        
        // 尝试后台复制
        var t = document.createElement("textarea");
        t.value = url; document.body.appendChild(t); t.select();
        document.execCommand('copy');
        document.body.removeChild(t);

        // 直接在页面上显示链接
        document.getElementById('linkText').innerText = url;
        document.getElementById('shareZone').style.display = 'block';
        
        // 自动滚动到显示区
        document.getElementById('shareZone').scrollIntoView();
    }

    function match() {
        if(ms.length == 0) return;
        var used = {}, ts = [], pool = JSON.parse(JSON.stringify(ms));
        while(pool.length > 0) {
            var c = pool.shift(); if(used[c.n]) continue;
            var t = [c.n + '('+c.j+')']; used[c.n] = true;
            for(var i=0; i<c.pre.length; i++){
                if(!used[c.pre[i]] && t.length < 4){ t.push(c.pre[i]); used[c.pre[i]] = true; }
            }
            for(var i=0; i<ms.length;
