<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>组队助手</title>
    <style>
        :root { --p: #07c160; --bg: #f8f9fa; --card: #ffffff; --text: #444; --blue: #007aff; --red: #ee0a24; --gold: #ffb800; --orange: #ff9500; }
        body { font-family: "Heiti SC", "STHeiti", "SimHei", "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); font-weight: 300; }
        
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h3 { margin: 0 0 15px 0; font-size: 15px; font-weight: 400; color: #1a1a1a; display: flex; align-items: center; }
        h3::before { content: ""; width: 3px; height: 14px; background: var(--p); border-radius: 2px; margin-right: 8px; }
        
        textarea, input, select { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; outline: none; box-sizing: border-box; font-size: 13px; margin-bottom: 10px; }

        .btn { width: 100%; border: none; border-radius: 8px; padding: 12px; font-size: 15px; cursor: pointer; color: #fff; margin-bottom: 10px; display: block; text-align: center; font-weight: 400; }
        .btn-green { background: var(--p); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-orange { background: var(--orange); }
        .btn-group { display: flex; gap: 10px; }
        .btn-half { flex: 1; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 85%; padding: 25px 20px; border-radius: 15px; text-align: center; }
        
        .member-block { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .m-header-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .m-name-title { font-size: 18px; font-weight: bold; color: #000; }
        .m-info-right { font-size: 13px; }
        .btn-del-text { color: var(--red); border: 1px solid #ffccd3; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; background: #fff5f6; }
        
        .tag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .tag-box { border: 1px solid #eee; border-radius: 6px; padding: 12px 5px; text-align: center; background: #fff; }
        .tag-box.active { border-color: var(--p); background: #f0f9f4; }
        .tag-box .t-name { display: block; font-weight: bold; font-size: 16px; color: #000; margin-bottom: 4px; }
        .tag-box .t-sub { font-size: 12px; display: block; }
        
        .res-item { padding: 15px; border-radius: 12px; margin-top: 12px; font-size: 14px; line-height: 1.6; }
        .type-fixed { background: #f0f7ff; border-left: 5px solid #2f88ff; }
        .type-match { background: #f6fbf8; border-left: 5px solid #07c160; }
        .res-title { font-weight: bold; font-size: 15px; color: #333; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div id="parseModal" class="modal">
    <div class="modal-content">
        <h3 style="justify-content:center; color:var(--p);">识别成功</h3>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <div id="parseSummary" style="text-align:left; line-height:2.2; font-size:15px;"></div>
        <button class="btn btn-green" style="margin-top:20px;" onclick="document.getElementById('parseModal').style.display='none'">确认并继续</button>
    </div>
</div>

<div class="card">
    <h3>1. 录入数据</h3>
    <textarea id="importBox" placeholder="在此粘贴接龙文本..."></textarea>
    <button class="btn btn-green" onclick="smartImport()">智能解析</button>
    
    <div style="background:#fdfdfd; border:1px dashed #ddd; padding:12px; border-radius:10px;">
        <input type="text" id="m_name" placeholder="昵称">
        <select id="m_job">
            <option value="术士">术士</option><option value="贤者">贤者</option><option value="骑士">骑士</option><option value="斗士">斗士</option>
        </select>
        <input type="number" id="m_power" placeholder="战力数值">
        <button class="btn btn-orange" style="margin:0; padding:8px;" onclick="addManual()">确认加入名单</button>
    </div>

    <div class="btn-group" style="margin-top:15px;">
        <button class="btn btn-blue btn-half" onclick="openShare()">分享页面</button>
        <button class="btn btn-red btn-half" onclick="clearAll()">重置数据</button>
    </div>
</div>

<div class="card">
    <h3>2. 待匹配人员</h3>
    <div id="list"></div>
</div>

<button class="btn btn-blue" style="font-size: 17px; padding: 18px; border-radius:15px; font-weight:bold;" onclick="match()">生成方案 (强强进位填补)</button>
<div id="res"></div>

<script>
    let ms = [], fixedTs = [], unit = "万";
    const JOBS = ["术士", "骑士", "斗士", "贤者"];
    const STATUS = ["未组队", "尚未", "待组", "缺", "差", "补"];

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const d = urlParams.get('d');
        if(d) {
            try {
                const json = JSON.parse(decodeURIComponent(atob(d)));
                ms = json.ms; fixedTs = json.fs; unit = json.u; render(); return;
            } catch(e) {}
        }
        ms = JSON.parse(localStorage.getItem('tm_ms') || '[]');
        fixedTs = JSON.parse(localStorage.getItem('tm_fs') || '[]');
        unit = localStorage.getItem('tm_u') || '万';
        render();
    }

    function smartImport() {
        const text = document.getElementById('importBox').value;
        if(!text.trim()) return;
        unit = text.includes("亿") ? "亿" : "万";
        const lines = text.split('\n');
        let tM = [], tF = [], allF = new Set();
        lines.forEach(l => {
            const row = l.trim();
            if(!/^\d+\./.test(row)) return;
            const blocks = row.replace(/^\d+\.\s*/, '').split(/\s+/).filter(b => b.length > 0);
            if (!STATUS.some(s => row.includes(s)) && blocks.length >= 4) {
                const names = blocks.slice(0, 4);
                tF.push(names.join(' 、 '));
                names.forEach(n => allF.add(n));
            } else if (blocks.length > 0) {
                const name = blocks[0];
                if(!allF.has(name)) {
                    let job = "未知";
                    JOBS.forEach(j => { if(row.includes(j)) job = j; });
                    const pMatch = row.match(/(\d+\.?\d*)/g);
                    const pVal = pMatch ? parseFloat(pMatch[pMatch.length - 1]) : 0;
                    if(!tM.some(m => m.n === name)) tM.push({n: name, j: job, p: pVal, pre: []});
                }
            }
        });
        ms = tM.filter(m => !allF.has(m.n)); fixedTs = tF;
        save(); render();
        const summary = `
            ♦ 固定组 (已成)： <span style="color:var(--blue); font-weight:bold;">${fixedTs.length}</span> 组<br>
            ♦ 待匹配人员： <span style="color:var(--p); font-weight:bold;">${ms.length}</span> 名<br>
            ♦ 战力单位： <span style="color:var(--red); font-weight:bold;">${unit}</span>
        `;
        document.getElementById('parseSummary').innerHTML = summary;
        document.getElementById('parseModal').style.display = 'flex';
        document.getElementById('importBox').value = "";
    }

    function addManual() {
        const name = document.getElementById('m_name').value.trim();
        const job = document.getElementById('m_job').value;
        const power = parseFloat(document.getElementById('m_power').value);
        if(!name || isNaN(power)) return;
        ms.push({ n: name, j: job, p: power, pre: [] });
        save(); render();
        document.getElementById('m_name').value = ""; document.getElementById('m_power').value = "";
    }

    function removeOne(idx) {
        ms.splice(idx, 1); save(); render();
    }

    function render() {
        const box = document.getElementById('list');
        if(!ms.length) { box.innerHTML = '<div style="text-align:center;color:#bbb;padding:20px;">等待录入数据...</div>'; return; }
        box.innerHTML = ms.map((m, i) => `
            <div class="member-block">
                <div class="m-header-line">
                    <span class="m-name-title">${m.n}</span>
                    <div class="m-info-right">
                        <span style="color:var(--gold); font-weight:bold;">${m.j}</span> | 
                        <span style="color:var(--red);">${m.p}${unit}</span>
                        <span class="btn-del-text" onclick="removeOne(${i})">移除</span>
                    </div>
                </div>
                <div class="tag-grid">
                    ${ms.map((t, k) => i===k ? '' : `
                        <div class="tag-box ${m.pre.includes(t.n)?'active':''}" onclick="sel(${i},'${t.n}')">
                            <span class="t-name">${t.n}</span>
                            <span class="t-sub">
                                <span style="color:var(--red)">${t.p}${unit}</span> 
                                <span style="color:var(--gold); font-weight:bold;">${t.j}</span>
                            </span>
                        </div>`).join('')}
                </div>
            </div>`).join('');
    }

    function sel(idx, name) {
        const m = ms[idx], p = m.pre.indexOf(name);
        if(p > -1) m.pre.splice(p, 1);
        else { if(m.pre.length >= 3) return; m.pre.push(name); }
        save(); render();
    }

    function save() { 
        localStorage.setItem('tm_ms', JSON.stringify(ms)); 
        localStorage.setItem('tm_fs', JSON.stringify(fixedTs)); 
        localStorage.setItem('tm_u', unit);
    }

    function openShare() {
        const data = btoa(encodeURIComponent(JSON.stringify({ms, fs:fixedTs, u:unit})));
        window.prompt("分享链接：", window.location.origin + window.location.pathname + "?d=" + data);
    }

    function clearAll() { if(confirm("重置吗？")) { localStorage.clear(); location.reload(); } }

    // --- 核心算法：强强组向上填补意向组空位 ---
    function match() {
        let used = new Set(), intentResults = [], strongResults = [];
        // 全局按战力降序，确保“抢人”和“填补”都是由高到低
        let pool = [...ms].sort((a,b) => b.p - a.p);

        // 1. 处理意向组（战力高者优先抢人并成团）
        pool.forEach(m => {
            if (used.has(m.n)) return;
            if (m.pre.length > 0) {
                let team = [m]; 
                used.add(m.n);
                
                // 优先拉入勾选的队友
                m.pre.forEach(favName => {
                    if (team.length < 4 && !used.has(favName)) {
                        let f = pool.find(p => p.n === favName);
                        if (f) { team.push(f); used.add(f.n); }
                    }
                });

                // 进位填补：如果勾选不满或人被抢了，从剩余池子里抽战力最高的人填满
                while (team.length < 4) {
                    let leftPool = pool.filter(p => !used.has(p.n));
                    if (leftPool.length === 0) break;

                    // 填补策略：优先补术士，其次补战力最高者 (实现强强进位)
                    leftPool.sort((a, b) => {
                        if (a.j === "术士" && b.j !== "术士") return -1;
                        if (b.j === "术士" && a.j !== "术士") return 1;
                        return b.p - a.p; // 战力高者进位
                    });
                    
                    let partner = leftPool[0];
                    team.push(partner);
                    used.add(partner.n);
                }
                intentResults.push(team);
            }
        });

        // 2. 处理剩余的强强组
        while (true) {
            let left = pool.filter(p => !used.has(p.n));
            if (left.length === 0) break;

            let team = [];
            let topSS = left.find(p => p.j === "术士");

            if (topSS) {
                team.push(topSS); used.add(topSS.n);
                let partners = pool.filter(p => !used.has(p.n)).slice(0, 4 - team.length);
                partners.forEach(p => { team.push(p); used.add(p.n); });
            } else {
                let topLeft = left.slice(0, 4);
                if (topLeft.length === 0) break;
                topLeft.forEach(p => { team.push(p); used.add(p.n); });
            }
            strongResults.push(team);
        }

        // 渲染结果
        let h = `<h3 style="margin-top:20px;">匹配方案结果</h3>`;
        fixedTs.forEach((t, i) => h += `<div class="res-item type-fixed"><span class="res-title">已成组 ${i+1}</span>${t}</div>`);
        
        intentResults.forEach((t, i) => {
            const hasSS = t.some(m => m.j==="术士") ? "" : " (缺术士)";
            h += `<div class="res-item type-match" style="border-left-color: var(--orange);"><span class="res-title">意向组 ${i+1}${hasSS}</span>${t.map(m => `<b>${m.n}</b>(<span style="color:var(--red)">${m.p}${unit}</span> <span style="color:var(--gold); font-weight:bold;">${m.j}</span>)`).join(' 、 ')}</div>`;
        });

        strongResults.forEach((t, i) => {
            const hasSS = t.some(m => m.j==="术士") ? "" : " (缺术士)";
            h += `<div class="res-item type-match"><span class="res-title">强强组 ${i+1}${hasSS}</span>${t.map(m => `<b>${m.n}</b>(<span style="color:var(--red)">${m.p}${unit}</span> <span style="color:var(--gold); font-weight:bold;">${m.j}</span>)`).join(' 、 ')}</div>`;
        });

        document.getElementById('res').innerHTML = h;
        document.getElementById('res').scrollIntoView();
    }
</script>
</body>
</html>
