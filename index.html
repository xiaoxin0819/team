<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>微信组队助手</title>
    <style>
        :root { --p: #07c160; --bg: #f7f7f7; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; -webkit-tap-highlight-color:transparent; }
        .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 16px; display: block; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: #fff; margin-bottom: 10px; font-size: 16px; cursor: pointer; display: block; }
        .btn-green { background: var(--p); }
        .btn-orange { background: #fa9d3b; }
        .member { background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .tag { display: inline-block; padding: 8px 12px; background: #f2f2f2; border-radius: 6px; margin: 5px 5px 0 0; font-size: 14px; }
        .tag.active { background: var(--p); color: #fff; }
        .res-box { background: #fff; border-left: 4px solid var(--p); padding: 10px; margin-top: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div class="card" id="adm">
        <h3 style="margin-top:0">1. 成员录入</h3>
        <input id="un" type="text" placeholder="输入昵称">
        <input id="uj" type="text" placeholder="输入职业">
        <input id="up" type="text" placeholder="输入战力">
        <button class="btn btn-green" onclick="addMember()">确定录入</button>
        <button class="btn btn-orange" onclick="copyShareLink()">生成分享链接并复制</button>
    </div>
    <div class="card">
        <h3 style="margin-top:0">2. 勾选意向 (限选3人)</h3>
        <div id="list"></div>
    </div>
    <button class="btn" style="background:#10aeff;" onclick="startMatch()">点击生成匹配结果</button>
    <div id="result"></div>

<script>
    let ms = [];
    const MAX = 3;

    window.onload = function() {
        const p = new URLSearchParams(window.location.search);
        const d = p.get('d');
        if (d) {
            try {
                ms = JSON.parse(decodeURIComponent(d));
                render();
            } catch(e) { console.error(e); }
        }
    };

    function addMember() {
        const n = document.getElementById('un').value.trim();
        const j = document.getElementById('uj').value.trim();
        const p = document.getElementById('up').value.trim();
        if (!n || !j || !p) { alert("请填全信息"); return; }
        if (ms.some(m => m.n === n)) { alert("昵称重复"); return; }
        ms.push({ n, j, p, pre: [] });
        render();
        document.getElementById('un').value = '';
    }

    function render() {
        const container = document.getElementById('list');
        if (ms.length === 0) {
            container.innerHTML = '<p style="color:#999;text-align:center;">暂无成员</p>';
            return;
        }
        container.innerHTML = ms.map((m, i) => `
            <div class="member">
                <b>${m.n}</b> (${m.j} | ${m.p})<br>
                <small style="color:red">已选: ${m.pre.length}/${MAX}</small><br>
                ${ms.map(o => o.n == m.n ? '' : `<span class="tag ${m.pre.includes(o.n) ? 'active' : ''}" onclick="toggleSelect(${i},'${o.n}')">${o.n}</span>`).join('')}
            </div>
        `).join('');
    }

    function toggleSelect(i, t) {
        let m = ms[i];
        if (m.pre.includes(t)) {
            m.pre = m.pre.filter(x => x !== t);
        } else {
            if (m.pre.length >= MAX) { alert("最多选3个"); return; }
            m.pre.push(t);
        }
        render();
    }

    function copyShareLink() {
        if(ms.length === 0) { alert("没数据"); return; }
        const d = encodeURIComponent(JSON.stringify(ms));
        const url = window.location.origin + window.location.pathname + '?d=' + d;
        const t = document.createElement('textarea');
        t.value = url;
        document.body.appendChild(t);
        t.select();
        document.execCommand('copy');
        document.body.removeChild(t);
        alert("链接已复制，去微信群发送");
    }

    function startMatch() {
        if(ms.length === 0) return;
        let used = new Set(), teams = [], pool = JSON.parse(JSON.stringify(ms));
        while (pool.length > 0) {
            let c = pool.shift(); 
            if (used.has(c.n)) continue;
            let team = [c.n + '(' + c.j + ')']; 
            used.add(c.n);
            for (let n of c.pre) if (!used.has(n) && team.length < 4) { team.push(n); used.add(n); }
            for (let x of ms) if (!used.has(x.n) && team.length < 4) { team.push(x.n); used.add(x.n); }
            teams.push(team);
        }
        document.getElementById('result').innerHTML = teams.map((t, i) => `<div class="res-box"><b>组${i + 1}：</b>${t.join('、')}</div>`).join('');
    }
</script>
</body>
</html>
