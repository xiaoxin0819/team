<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <title>组队助手</title>
    <style>
        :root { 
            --p: #07c160; --bg: #f5f7fa; --card: #ffffff; --text: #333; 
            --blue: #007aff; --red: #ff3b30; --gold: #FFD700; 
            --orange: #ff9500; --darkred: #a52a2a; 
        }
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: var(--bg); margin: 0; padding: 15px; color: var(--text); -webkit-font-smoothing: antialiased;
        }
        .card { background: var(--card); border-radius: 14px; padding: 18px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h3 { margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #000; display: flex; align-items: center; }
        h3::before { content: ""; width: 4px; height: 16px; background: var(--p); border-radius: 2px; margin-right: 8px; }
        .m-name-title { font-size: 20px; font-weight: 700; color: #000 !important; }
        .job-label, .power-label { font-size: 15px; font-weight: 400 !important; }
        .job-骑士 { color: var(--gold) !important; }
        .job-术士 { color: var(--blue) !important; font-weight: 600 !important; }
        .job-贤者 { color: var(--p) !important; }
        .job-斗士 { color: var(--darkred) !important; }
        .highlight-red { color: var(--red) !important; font-weight: 500; }
        
        .side-nav {
            position: fixed; right: 15px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; z-index: 999;
        }
        .nav-btn {
            width: 48px; height: 48px; background: rgba(255,255,255,0.85);
            border: 1px solid rgba(0,0,0,0.08); border-radius: 50%; color: var(--blue);
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.12); backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); transition: all 0.2s;
        }
        .nav-btn:active { background: #fff; transform: scale(0.9); }
        .nav-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 3; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .del-btn { background: #ffeef0; color: var(--red); border: 1px solid #ffccc7; padding: 5px 12px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; margin-left: 15px; }
        #toast { position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 10px; z-index: 9999; display: none; font-size: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none; }
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-box { background: #fff; width: 85%; max-width: 400px; border-radius: 15px; padding: 20px; text-align: center; }
        .share-url-box { width: 100%; padding: 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; word-break: break-all; margin: 15px 0; min-height: 80px; display: block; box-sizing: border-box; color: #555; }
        textarea, input, select { width: 100%; padding: 12px; border: 1px solid #efefef; border-radius: 8px; background: #fafafa; outline: none; box-sizing: border-box; font-size: 15px; margin-bottom: 10px; }
        .btn { width: 100%; border: none; border-radius: 10px; padding: 14px; font-size: 16px; font-weight: 600; cursor: pointer; color: #fff; margin-bottom: 10px; display: block; text-align: center; }
        .btn-green { background: var(--p); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-orange { background: var(--orange); }
        .tag-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tag-box { border: 1px solid #f0f0f0; border-radius: 8px; padding: 12px 5px; text-align: center; background: #fff; cursor: pointer; }
        .tag-box.active { border-color: var(--p); background: #f0f9f4; box-shadow: 0 0 0 2px var(--p); }
        .tag-name { display: block; font-size: 18px; color: #000; font-weight: 700; margin-bottom: 2px; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .res-person { background: #fff; padding: 12px 4px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
        .res-person b { font-size: 19px; color: #000; font-weight: 700; display: block; margin-bottom: 4px; }
        .res-person span { font-size: 14px; font-weight: 400; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="side-nav">
    <button class="nav-btn" onclick="window.scrollTo({top:0, behavior:'smooth'})"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M18 15l-6-6-6 6"/></svg></button>
    <button class="nav-btn" onclick="window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'})"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg></button>
</div>

<div id="modalOverlay">
    <div class="modal-box">
        <h3 style="justify-content: center;">分享链接</h3>
        <textarea id="shareUrl" class="share-url-box" readonly></textarea>
        <button class="btn btn-green" onclick="copyUrl()">一键复制接力链接</button>
        <button class="btn btn-red" style="margin-bottom:0" onclick="closeModal()">关闭</button>
    </div>
</div>

<div class="card">
    <h3>1. 录入数据</h3>
    <textarea id="importBox" placeholder="粘贴接龙文本..."></textarea>
    <button class="btn btn-green" onclick="smartImport()">智能解析</button>
    <div style="background:#fcfcfc; border:1px dashed #ccc; padding:15px; border-radius:10px; margin-top:10px;">
        <input type="text" id="m_name" placeholder="昵称">
        <select id="m_job">
            <option value="术士">术士</option><option value="贤者">贤者</option><option value="骑士">骑士</option><option value="斗士">斗士</option>
        </select>
        <input type="number" id="m_power" placeholder="战力数值">
        <button class="btn btn-orange" style="margin-bottom:0" onclick="addManual()">确认加入名单</button>
    </div>
    <div style="display:flex; gap:10px; margin-top:10px;">
        <button class="btn btn-blue" style="flex:1; margin-bottom:0" onclick="openShareModal()">分享页面</button>
        <button class="btn btn-red" style="flex:1; margin-bottom:0" onclick="clearAll()">重置数据</button>
    </div>
</div>

<div class="card"><h3>2. 待匹配人员</h3><div id="list"></div></div>
<button class="btn btn-blue" style="font-size: 18px; padding: 18px; font-weight:600; border-radius:12px;" onclick="match()">生成方案</button>
<div id="res"></div>

<script>
    let ms = [], fixedTs = [], unit = "万";
    const JOBS_PRIORITY = ["术士", "贤者", "骑士", "斗士"];
    const JOB_MAP = { "术士": 0, "贤者": 1, "骑士": 2, "斗士": 3 };
    const REV_MAP = ["术士", "贤者", "骑士", "斗士"];
    const STATUS = ["未组队", "尚未", "待组", "缺", "差", "补"];

    function showMsg(text, type = 'info') {
        const t = document.getElementById('toast');
        t.innerText = text;
        t.style.background = type === 'err' ? 'rgba(255,59,48,0.9)' : 'rgba(7,193,96,0.9)';
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 2000);
    }

    function openShareModal() {
        const compressedMs = ms.map(m => ({ n: m.n, j: JOB_MAP[m.j] ?? 9, p: m.p, r: m.pre }));
        const data = { m: compressedMs, f: fixedTs.map(t => t.map(p => ({ n: p.n, j: JOB_MAP[p.j] ?? 9 }))), u: unit === "亿" ? 1 : 0 };
        const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
        const url = window.location.origin + window.location.pathname + "?d=" + encoded;
        document.getElementById('shareUrl').value = url;
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    function copyUrl() {
        const u = document.getElementById('shareUrl'); u.select(); u.setSelectionRange(0, 99999);
        document.execCommand('copy'); showMsg("链接已复制");
    }

    window.onload = function() {
        const d = new URLSearchParams(window.location.search).get('d');
        if (d) {
            try {
                const raw = JSON.parse(decodeURIComponent(atob(d)));
                ms = (raw.m || []).map(m => ({ n: m.n, j: REV_MAP[m.j] || "未知", p: m.p, pre: m.r || [] }));
                fixedTs = (raw.f || []).map(t => t.map(p => ({ n: p.n, j: REV_MAP[p.j] || "未知" })));
                unit = raw.u === 1 ? "亿" : "万";
                save(); window.history.replaceState({}, document.title, window.location.pathname);
            } catch (e) { loadFromLocal(); }
        } else { loadFromLocal(); }
        render();
    }

    function loadFromLocal() {
        ms = JSON.parse(localStorage.getItem('tm_ms') || '[]');
        fixedTs = JSON.parse(localStorage.getItem('tm_fs') || '[]');
        unit = localStorage.getItem('tm_u') || '万';
    }

    function smartImport() {
        const text = document.getElementById('importBox').value;
        if(!text.trim()) return;
        unit = text.includes("亿") ? "亿" : "万";
        const lines = text.split('\n');
        let tM = [], tF = [], allF = new Set();
        lines.forEach(l => {
            const row = l.trim();
            if(!/^\d+\./.test(row)) return;
            const blocks = row.replace(/^\d+\.\s*/, '').split(/\s+/).filter(b => b.length > 0);
            if (!STATUS.some(s => row.includes(s)) && blocks.length >= 4) {
                const names = blocks.slice(0, 4);
                let teamMembers = names.map(n => {
                    let job = "未知";
                    JOBS_PRIORITY.forEach(j => { if(row.includes(j)) job = j; });
                    return { n, j: job };
                });
                tF.push(teamMembers);
                names.forEach(n => allF.add(n));
            } else if (blocks.length > 0) {
                const name = blocks[0];
                if(!allF.has(name)) {
                    let job = "未知";
                    JOBS_PRIORITY.forEach(j => { if(row.includes(j)) job = j; });
                    const pMatch = row.match(/(\d+\.?\d*)/g);
                    const pVal = pMatch ? parseFloat(pMatch[pMatch.length - 1]) : 0;
                    if(!tM.some(m => m.n === name)) tM.push({n: name, j: job, p: pVal, pre: []});
                }
            }
        });
        ms = tM; fixedTs = tF; save(); render(); showMsg("导入完成");
    }

    function addManual() {
        const nI = document.getElementById('m_name'), pI = document.getElementById('m_power');
        const name = nI.value.trim(), job = document.getElementById('m_job').value, power = parseFloat(pI.value);
        if(!name || isNaN(power)) return;
        ms.push({ n: name, j: job, p: power, pre: [] });
        save(); render(); nI.value = ""; pI.value = "";
    }

    function render() {
        const box = document.getElementById('list');
        box.innerHTML = ms.map((m, i) => `
            <div style="margin-bottom:20px; border-bottom:1px solid #f0f0f0; padding-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <span class="m-name-title">${m.n}</span>
                    <div style="display:flex; align-items:center;">
                        <div class="job-label"><span class="job-${m.j}">${m.j}</span> | <span class="highlight-red">${m.p}${unit}</span></div>
                        <button class="del-btn" onclick="ms.splice(${i},1);save();render();">移除</button>
                    </div>
                </div>
                <div class="tag-grid">
                    ${ms.map((t, k) => i===k ? '' : `
                        <div class="tag-box ${m.pre.includes(t.n)?'active':''}" onclick="sel(${i},'${t.n}')">
                            <span class="tag-name">${t.n}</span>
                            <span class="job-label"><span class="job-${t.j}">${t.j}</span> | <span class="highlight-red">${t.p}${unit}</span></span>
                        </div>`).join('')}
                </div>
            </div>`).join('');
    }

    function sel(idx, name) {
        const m = ms[idx], p = m.pre.indexOf(name);
        if(p > -1) m.pre.splice(p, 1); else if(m.pre.length < 3) m.pre.push(name);
        save(); render();
    }

    function save() { localStorage.setItem('tm_ms', JSON.stringify(ms)); localStorage.setItem('tm_fs', JSON.stringify(fixedTs)); localStorage.setItem('tm_u', unit); }
    function clearAll() { if(confirm("重置所有数据？")) { localStorage.clear(); location.reload(); } }

    function match() {
        if(ms.length === 0 && fixedTs.length === 0) return;
        let used = new Set(), results = [];
        let pool = [...ms].sort((a,b) => b.p - a.p);
        
        const canAddJob = (team, job) => {
            const count = team.filter(m => m.j === job).length;
            if (job === "贤者" || job === "骑士") return count < 1;
            if (job === "术士" || job === "斗士") return count < 2;
            return true;
        };

        // 核心改动：基于队伍最低战力的 5% 冗余逻辑
        const findBestPartner = (team, leftList) => {
            if (leftList.length === 0) return null;
            // 获取当前队伍中的最低战力
            const minPowerInTeam = Math.min(...team.map(m => m.p));
            const threshold = minPowerInTeam * 0.95;

            // 1. 尝试按【优先级顺序】寻找符合【动态阈值】的队友
            for (let jobName of JOBS_PRIORITY) {
                if (!canAddJob(team, jobName)) continue;
                // 在剩余名单里找，只要比队内最低者低不到 5% 且符合职业
                let partner = leftList.find(x => x.j === jobName && x.p >= threshold);
                if (partner) return partner;
            }

            // 2. 如果 5% 范围内没找到完美阵容，降级：寻找符合职业要求的最高战力者（阵容冲突规避）
            for (let jobName of JOBS_PRIORITY) {
                if (!canAddJob(team, jobName)) continue;
                let partner = leftList.find(x => x.j === jobName);
                if (partner) return partner;
            }

            // 3. 实在没有符合名额的职业了，被迫拿剩余池里战力最高的（保底逻辑）
            return leftList[0]; 
        };

        // --- 1. 处理意向匹配 ---
        pool.forEach(m => {
            if (used.has(m.n)) return;
            if (m.pre.length > 0) {
                let team = [m]; used.add(m.n);
                m.pre.forEach(fn => {
                    if (team.length < 4 && !used.has(fn)) {
                        let f = pool.find(p => p.n === fn);
                        if (f && canAddJob(team, f.j)) { team.push(f); used.add(fn); }
                    }
                });
                while (team.length < 4) {
                    let left = pool.filter(p => !used.has(p.n));
                    if (left.length === 0) break;
                    let p = findBestPartner(team, left);
                    team.push(p); used.add(p.n);
                }
                results.push(team);
            }
        });

        // --- 2. 处理常规匹配 ---
        while (true) {
            let left = pool.filter(p => !used.has(p.n));
            if (left.length === 0) break;
            let team = []; let leader = left[0];
            team.push(leader); used.add(leader.n);
            
            while(team.length < 4) {
                let currentLeft = pool.filter(p => !used.has(p.n));
                if(currentLeft.length === 0) break;
                let partner = findBestPartner(team, currentLeft);
                team.push(partner); used.add(partner.n);
            }
            results.push(team);
        }

        // --- 3. 渲染结果 ---
        let h = `<h3>匹配方案结果</h3>`;
        fixedTs.forEach((team, i) => {
            h += `<div class="card" style="background:#f0f7ff; border-left:5px solid var(--blue);"><b>锁定队 ${i+1}</b><div class="res-grid">`;
            team.forEach(m => { h += `<div class="res-person"><b>${m.n}</b><span><span class="job-${m.j}">${m.j}</span></span></div>`; });
            h += `</div></div>`;
        });
        results.forEach((t, i) => {
            h += `<div class="card" style="background:#f6fbf8; border-left:5px solid var(--p);"><b>匹配组 ${i+1}</b><div class="res-grid">`;
            t.forEach(m => { h += `<div class="res-person"><b>${m.n}</b><span><span class="job-${m.j}">${m.j}</span> | <span class="highlight-red">${m.p}${unit}</span></span></div>`; });
            h += `</div></div>`;
        });
        document.getElementById('res').innerHTML = h;
        showMsg("匹配完成");
        document.getElementById('res').scrollIntoView({ behavior: 'smooth' });
    }
</script>
</body>
</html>
